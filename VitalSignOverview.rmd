---
title: ""
author: ""
date: ""
output: 
  html_document: 
    toc: true 
    toc_depth: 3
    toc_float: true
params:
  VSID: 0
---

```{r setup, include=FALSE,echo=FALSE}
# Move the VSID from the report parameters in the YAML above to a variable
VSID = params$VSID
#VSID=18

# Setup knitr
knitr::opts_chunk$set(echo = TRUE)


# Load libraries
library(odbc)
library(tidyverse)

# Database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inp2300irmadb01\\ntwk", Database = "AKRO")

# Function to fix an SQL query by replacing every comma with a newline - makes sql more readable
FixSql = function(Sql) {
  FixedSql = gsub(",", "\n,", Sql)
  FixedSql = gsub(", ", ",", FixedSql)
  return(FixedSql)
}
```

```{r,label="Get the Vital Sign overview info", echo=FALSE}

# Build a query
Sql = paste("SELECT 
Acronym
,NetworkVSName AS VitalSign
,ProjectLeadLastname + ', ' + ProjectLeadFirstname as ProjectLeader
,'<a href=\"mailto:' + ProjectLeadEmail + '\">' + ProjectLeadEmail + '</a>' as Email
,ProjectLeadTelephone as Telephone
,Convert(varchar(8000),Overview) As Overview
,Status
,Convert(Date,ImplementationDate) as ImplementationDate
,Replace(FilesDirectory,'\','\\') as Directory
,Website
,Convert(varchar(1000),Address) as Address
,'[https://irma.nps.gov/DataStore/Reference/Profile/' + Convert(varchar(20),IRMAProjectReference) + '](https://irma.nps.gov/DataStore/Reference/Profile/' + Convert(varchar(20),IRMAProjectReference) + ')' as NPSDataStore
,ProjectLeadContactID
,NetworkID,Network
,VSID
FROM vwVitalSignOverview
WHERE (VSID = ",VSID,")",sep="")

# Vital Sign overview data frame
vs = dbGetQuery(Connection,Sql)

# Fix the directory path so it will show OK in markdown
vs$Directory = gsub("\\\\", "\\\\\\\\", vs$Directory)

# Get the overview into a variable so it can be displayed in markdown
# Clean it so it displays in markdown better
#Overview = gsub("\r\n", "\n", vs$Overview) # iconv(vs$Overview, from = "UTF-8", to = "ASCII//TRANSLIT", sub = "") 
Overview = iconv(vs$Overview, from = "UTF-8", to = "ASCII//TRANSLIT", sub = "") 

```



# `r vs$VitalSign`
### Vital Sign Overview Report
*National Park Service, `r vs$Network` Inventory and Monitoring Program*

Scott D. Miller  
Information Technology Specialist
National Park Service, Arctic Inventory and Monitoring Network  
240 W. 5th Ave  
Anchorage, AK 99501  

`r format(Sys.Date(), "%B %d, %Y")`

# Overview

`r Overview`

# Details

Details regarding the `r vs$VitalSign` monitoring program appear in Table 1.

```{r,label="Show the VS Details",echo=FALSE,tab.cap=paste("Table 1. ",vs$VitalSign," monitoring program details.",sep="")}

# Extract the vital sign details, transpose it tall and skinny
knitr::kable(t(vs %>% select(VitalSign
 ,ProjectLeader
 ,Email
,Telephone
,Status
,ImplementationDate
,Directory
,Website
,Address
,NPSDataStore)),escape = TRUE,na.rm=TRUE)

```

# Protocols 

Table 2. shows the monitoring protocol(s) that have been implemented for the `r vs$VitalSign` monitoring program. Also shown are the schedule of deliverables to be fulfilled during each remeasurement cycle, and a list of completed remeasurements..

```{r,label="VS Protocols",echo=FALSE,tab.cap=paste("Table 2. ",vs$VitalSign," monitoring protocol(s).",sep="")}

Sql = paste("SELECT [ProtocolTitle]
,[ProtocolCitation]
,[Version]
,[IRMAReferenceCode]
,[DateNarrativePublished]
,[DQSReferenceCode]
,[PIPSourceReferenceCode]
,[QAPReferenceCode]
--,[Notes]
--,[DocumentID]
--,[RecordInsertedDate]
--,[RecordInsertedBy]
--,[VSID]
,[ProtocolID]
  FROM [AKRO].[dbo].[tblVitalSignProtocols]
WHERE (VSID = ",VSID,") ORDER BY Version DESC",sep="")
protocols = dbGetQuery(Connection,Sql)
protocols$ProtocolCitation = iconv(protocols$ProtocolCitation, from = "UTF-8", to = "ASCII//TRANSLIT", sub = "")

```

```{r,label="output protocols",results='asis',echo=FALSE}
for(i in 1:nrow(protocols)){
  Title = protocols[i,'ProtocolTitle']
  Citation = protocols[i,'ProtocolCitation']
  ProtocolID = protocols[i,"ProtocolID"]
  RefCode = protocols[i,"IRMAReferenceCode"]
  ProtocolReference = paste("[",Citation,"](https://irma.nps.gov/DataStore/Reference/Profile/",RefCode,") \n",sep="")
  cat("## ",Citation,"  \n")
  
  
  cat("### Deliverables Schedule  \n")
  
  Sql = paste("SELECT  [DeliverableIdentifier]
,[Deliverable]
--,[SOP]
--,[SOPVersion]
--,[Format]
	  ,[Description]
,[Schedule]
,[Responsibility]
--,[Specifications]
--,[FileNamingScheme]
--,[DataHandling]
--,[QAQC]
--,[Archival]
--,[BuilderTasks]
--,[ValidatorTasks]
--,[CertifierTasks]
--,[DeliverableID]
--,[ProtocolID]
--,[RecordInsertedDate]
--,[RecordInsertedBy]
  FROM [AKRO].[dbo].[tblProtocolDeliverables]
 WHERE ProtocolID=",ProtocolID," ORDER BY DeliverableIdentifier",sep="")
    ds = dbGetQuery(Connection,Sql)
    cat("This protocol describes the collection, delivery and management of ",nrow(ds)," deliverables.\n\n",ProtocolReference,"  \n")
    print(knitr::kable(ds))
    
  cat("### Remeasurements  \n")
  
  Sql = paste("SELECT [Description]
      --,[BeginDate]
      --,[EndDate]
      ,'https://irma.nps.gov/DataStore/Reference/Profile/'+ Convert(Varchar(20),[DeliverablesIRMAReferenceCode]) as Deliverables
      ,'https://irma.nps.gov/DataStore/Reference/Profile/'+ Convert(Varchar(20),[ReportIRMAReferenceCode]) as Report
      ,[Notes]
      --,[RemeasurementAbstract]
      --,[ProtocolID]
      --,[RecordInsertedDate]
      --,[RecordInsertedBy]
      --,[RemeasurementID]
  FROM [AKRO].[dbo].[tblProtocolRemeasurements]
 WHERE ProtocolID=",ProtocolID,"
 ORDER BY Description DESC",sep="")
    rm = dbGetQuery(Connection,Sql)
    cat("This protocol has been used during ",nrow(rm)," remeasurements:\n\n",Citation,"  \n")
    print(knitr::kable(rm,na.rm=TRUE))
    
    
}

```


```{r,label="Write the report to the survey directory", echo=FALSE}

# This template will output to an html file named MooseSurveyReport.htms
# Rename it and copy it to the survey directory if it exists
# Otherwise rename it in the current directory
From = "VitalSignOverview.html"

# Set up the source file title
ReportTitle = paste(vs$Acronym," ",vs$VitalSign," Summary.html",sep="")

# Check if the survey directory exists
# Set up a destination file path for the file copy operation
# if (dir.exists(DashboardDF$DataResourcesDirectory)) {
#   To=paste(DashboardDF$DataResourcesDirectory,"/",ReportTitle,sep="")
# } else {
#   To=ReportTitle
# }
To=ReportTitle

print(paste("Printing ",From," to ",To,sep=""))

# Try to copy the file to the destination
tryCatch({
  file.copy(From, To, overwrite = TRUE)
  message(paste("Report ",From," generated and and copied to ",To,sep=""))
}, error = function(e) {
  
  # An error happened
  message("Error: ", e$message)
  
})


```










```{r,echo=FALSE}
# Install and load the httr package
#install.packages("httr")
# library(httr)
# 
# # Define the URL for the GET request
# url = "https://irmaservices.nps.gov/datastore-secure/v7/rest/Profile/2285179"
# url = "https://irmaservices.nps.gov/datastore/v7/rest/QuickSearch?q=moose&format=json"
# 
# # Moose Project (ARCN)
# url = "https://irmaservices.nps.gov/datastore/v7/rest/ReferenceCodeSearch?q=2222140&format=json"
# 
# # Make the GET request
# response <- GET(url)
# 
# # Check the status code of the response
# status_code <- status_code(response)
# 
# if (status_code == 200) {
#   # Parse the JSON content from the response
#   content <- content(response, "parsed", type = "application/json")
#   
#   # Print the parsed content
#   #print(content)
#   
#   # for (i in 1:length(content$items)){
#   #   print(i)
#   # }
#   
#   Title = content[[1]][["title"]]
#   print(Title)
# } else {
#   # Handle errors
#   print(paste("Request failed with status code", status_code))
# }
```
