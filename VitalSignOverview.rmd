---
title: ""
author: ""
date: ""
output: 
  html_document: 
    toc: true 
    toc_depth: 3
    toc_float: true
params:
  VSID: 0
---

```{r setup, include=FALSE,echo=FALSE}
# Setup knitr
knitr::opts_chunk$set(echo = TRUE)
# Load libraries
library(odbc)
library(tidyverse)

# Database connection
Connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inp2300irmadb01\\ntwk", Database = "AKRO")

# Set the VSID to the VitalSign you want:
if(params$VSID == 0){
  VSID = 18  #  ARCN   Brown Bears 
  # VSID = 19  #  ARCN   Caribou 
  VSID = 5  #  ARCN   Climate 
  # VSID = 7  #  ARCN   Coastal Shoreline Change 
  # VSID = 20  #  ARCN   Dall's Sheep 
  # VSID = 27  #  ARCN   Fire Extent and Severity 
  # VSID = 11  #  ARCN   Lagoon Communities and Ecosystems 
  # VSID = 12  #  ARCN   Lake Communities and Ecosystems 
  # VSID = 17  #  ARCN   Landbird Monitoring 
  # VSID = 21  #  ARCN   Moose 
  # VSID = 22  #  ARCN   Muskox 
  # VSID = 9  #  ARCN   Permafrost 
  # VSID = 133  #  ARCN   Shallow Lakes 
  # VSID = 13  #  ARCN   Stream Communities and Ecosystems 
  # VSID = 28  #  ARCN   Terrestrial Landscape Patterns and Dynamics 
  # VSID = 24  #  ARCN   Terrestrial Vegetation and Soils 
  # VSID = 81  #  ARCN   Western Yellow-billed Loons 
  # VSID = 40  #  CAKN   Air Quality 
  # VSID = 39  #  CAKN   Bald Eagle 
  # VSID = 134  #  CAKN   Caribou - DENA 
  # VSID = 49  #  CAKN   Caribou - WRST 
  # VSID = 36  #  CAKN   Climate 
  # VSID = 44  #  CAKN   Dall's Sheep 
  # VSID = 52  #  CAKN   Glaciers 
  # VSID = 54  #  CAKN   Golden Eagles 
  # VSID = 42  #  CAKN   Moose 
  # VSID = 38  #  CAKN   Passerines 
  # VSID = 31  #  CAKN   Peregrine Falcons 
  # VSID = 43  #  CAKN   Permafrost 
  # VSID = 51  #  CAKN   Plant Phenology 
  # VSID = 34  #  CAKN   Shallow Lakes 
  # VSID = 48  #  CAKN   Small Mammals 
  # VSID = 71  #  CAKN   Soundscape 
  # VSID = 72  #  CAKN   Streams and Rivers 
  # VSID = 37  #  CAKN   Vegetation Structure and Composition 
  # VSID = 45  #  CAKN   Wolves 
} else {
  VSID = params$VSID
}


# If you need an inventory of VSIDs:
# Get the vital signs
Sql = paste("SELECT Acronym,NetworkVSName,VSID FROM vwVitalSignOverview
  WHERE Status<>'Deferred' ORDER BY Acronym,NetworkVSName",sep="")
# Vital Sign overview data frame
VSInventory = dbGetQuery(Connection,Sql)
for(i in 1:nrow(VSInventory)){
  cat("VSID = ", VSInventory[i,'VSID']," # ",VSInventory[i,'Acronym']," ",VSInventory[i,'NetworkVSName'],"\n")
}


# Delete the existing html file
if (file.exists("VitalSignOverview.html")) {
  # Delete the file
  removed = file.remove("VitalSignOverview.html")
}



# Function to fix an SQL query by replacing every comma with a newline - makes sql more readable
FixSql = function(Sql) {
  FixedSql = gsub(",", "\n,", Sql)
  FixedSql = gsub(", ", ",", FixedSql)
  return(FixedSql)
}
```

# `r VSID`

```{r,label="Get the Vital Sign overview info", echo=FALSE}

# Build a query
Sql = paste("SELECT 
Acronym
,NetworkVSName AS VitalSign
,ProjectLeadLastname + ', ' + ProjectLeadFirstname as ProjectLeader
,'<a href=\"mailto:' + ProjectLeadEmail + '\">' + ProjectLeadEmail + '</a>' as Email
,ProjectLeadTelephone as Telephone
,Convert(varchar(8000),Overview) As Overview
,Status
,Convert(Date,ImplementationDate) as ImplementationDate
,Replace(FilesDirectory,'\','\\') as Directory
,Website
,Convert(varchar(1000),Address) as Address
,'[https://irma.nps.gov/DataStore/Reference/Profile/' + Convert(varchar(20),IRMAProjectReference) + '](https://irma.nps.gov/DataStore/Reference/Profile/' + Convert(varchar(20),IRMAProjectReference) + ')' as NPSDataStore
,ProjectLeadContactID
,NetworkID,Network
,VSID
FROM vwVitalSignOverview
WHERE (VSID = ",VSID,")",sep="")

# Vital Sign overview data frame
vs = dbGetQuery(Connection,Sql)

# Fix the directory path so it will show OK in markdown
vs$Directory = gsub("\\\\", "\\\\\\\\", vs$Directory)

# Get the overview into a variable so it can be displayed in markdown
# Clean it so it displays in markdown better
#Overview = gsub("\r\n", "\n", vs$Overview) # iconv(vs$Overview, from = "UTF-8", to = "ASCII//TRANSLIT", sub = "") 
Overview = iconv(vs$Overview, from = "UTF-8", to = "ASCII//TRANSLIT", sub = "") 

```



# `r vs$VitalSign`
### Vital Sign Overview Report
*National Park Service, `r vs$Network` Inventory and Monitoring Program*

Scott D. Miller  
Information Technology Specialist
National Park Service, Arctic Inventory and Monitoring Network  
240 W. 5th Ave  
Anchorage, AK 99501  

`r format(Sys.Date(), "%B %d, %Y")`

# Overview

`r Overview`

# Details

Details regarding the `r vs$VitalSign` monitoring program appear in Table 1.

```{r,label="Show the VS Details",echo=FALSE,tab.cap=paste("Table 1. ",vs$VitalSign," monitoring program details.",sep="")}

# Extract the vital sign details, transpose it tall and skinny
knitr::kable(t(vs %>% select(VitalSign
 ,ProjectLeader
 ,Email
,Telephone
,Status
,ImplementationDate
,Directory
,Website
,Address
,NPSDataStore,VSID)),escape = TRUE,na.rm=TRUE)

```

# Protocols 

Table 2. shows the monitoring protocol(s) that have been implemented for the `r vs$VitalSign` monitoring program. Also shown are the schedule of deliverables to be fulfilled during each remeasurement cycle, and a list of completed remeasurements for the protocol.

```{r,label="VS Protocols",echo=FALSE,tab.cap=paste("Table 2. ",vs$VitalSign," monitoring protocol(s).",sep="")}

Sql = paste("SELECT [ProtocolTitle]
,[ProtocolCitation]
,[Version]
,[IRMAReferenceCode]
,[DateNarrativePublished]
,[DQSReferenceCode]
,[PIPSourceReferenceCode]
,[QAPReferenceCode]
--,[Notes]
--,[DocumentID]
--,[RecordInsertedDate]
--,[RecordInsertedBy]
--,[VSID]
,[ProtocolID]
  FROM [AKRO].[dbo].[tblVitalSignProtocols]
WHERE (VSID = ",VSID,") ORDER BY Version DESC",sep="")
protocols = dbGetQuery(Connection,Sql)
protocols$ProtocolCitation = iconv(protocols$ProtocolCitation, from = "UTF-8", to = "ASCII//TRANSLIT", sub = "")

```


```{r,label="output protocols",results='asis',echo=FALSE}
for(i in 1:nrow(protocols)){
  Title = protocols[i,'ProtocolTitle']
  Citation = protocols[i,'ProtocolCitation']
  ProtocolID = protocols[i,"ProtocolID"]
  RefCode = protocols[i,"IRMAReferenceCode"]
  ProtocolReference = paste("[",Citation,"](https://irma.nps.gov/DataStore/Reference/Profile/",RefCode,") \n",sep="")
  cat("## ",Citation,"  \n")
 
  print(knitr::kable(protocols))
  
  cat("### Deliverables Schedule  \n")
  
  Sql = paste("SELECT  [DeliverableIdentifier]
,[Deliverable]
--,[SOP]
--,[SOPVersion]
--,[Format]
	  ,[Description]
,[Schedule]
,[Responsibility]
  FROM [AKRO].[dbo].[tblProtocolDeliverables]
 --WHERE ProtocolID=",ProtocolID," 
ORDER BY DeliverableIdentifier",sep="")
  cat("\n\n",Sql,"  \n\n")
  ds = dbGetQuery(Connection,Sql)
    
    cat("This protocol describes the collection, delivery and management of ",nrow(ds)," deliverables.  \n\n",ProtocolReference,"  \n  ")
    
    cat("  \n\n")
    print(knitr::kable(ds %>% filter(ProtocolID == protocols$ProtocolID)))
    cat("  \n\n")
    
  cat("### Remeasurements  \n  ")

  Sql = paste("SELECT [Description]
      --,[BeginDate]
      --,[EndDate]
      ,'https://irma.nps.gov/DataStore/Reference/Profile/'+ Convert(Varchar(20),[DeliverablesIRMAReferenceCode]) as Deliverables
      ,'https://irma.nps.gov/DataStore/Reference/Profile/'+ Convert(Varchar(20),[ReportIRMAReferenceCode]) as Report
      ,[Notes]
      --,[RemeasurementAbstract]
      --,[ProtocolID]
      --,[RecordInsertedDate]
      --,[RecordInsertedBy]
      --,[RemeasurementID]
  FROM [AKRO].[dbo].[tblProtocolRemeasurements]
 WHERE ProtocolID=",ProtocolID,"
 ORDER BY Description DESC",sep="")
    rm = dbGetQuery(Connection,Sql)
    cat("  \n")
    cat("This protocol has been used during ",nrow(rm)," remeasurements:\n\n",Citation,"  \n")
    cat("  \n")
    print(knitr::kable(rm,na.rm=TRUE))
    cat("  \n")

}

```


```{r,label="Write the report to the survey directory", echo=FALSE}

# This template will output to an html file named MooseSurveyReport.htms
# Rename it and copy it to the survey directory if it exists
# Otherwise rename it in the current directory
From = "VitalSignOverview.html"

# Set up the source file title
ReportTitle = paste(vs$Acronym," ",vs$VitalSign," Summary.html",sep="")

# Check if the survey directory exists
# Set up a destination file path for the file copy operation
# if (dir.exists(DashboardDF$DataResourcesDirectory)) {
#   To=paste(DashboardDF$DataResourcesDirectory,"/",ReportTitle,sep="")
# } else {
#   To=ReportTitle
# }
To=ReportTitle

# Try to copy the file to the destination
tryCatch({
  #printed = file.copy(From, To, overwrite = TRUE)
  #message(paste("Report ",From," generated and and copied to ",To,sep=""))
}, error = function(e) {
  
  # An error happened
  message("Error: ", e$message)
  
})


```










```{r,echo=FALSE}
# Install and load the httr package
#install.packages("httr")
# library(httr)
# 
# # Define the URL for the GET request
# ProjectReference = 2218298
# url = "https://irmaservices.nps.gov/datastore-secure/v7/rest/Profile/2285179"
# url = "https://irmaservices.nps.gov/datastore/v7/rest/QuickSearch?q=moose&format=json"
# 
# # Moose Project (ARCN)
# url = paste("https://irmaservices.nps.gov/datastore/v7/rest/ReferenceCodeSearch?q=",ProjectReference,"&format=json",sep="")
# 
# # Make the GET request
# response <- GET(url)
# 
# # Check the status code of the response
# status_code <- status_code(response)
# 
# if (status_code == 200) {
#   # Parse the JSON content from the response
#   content <- content(response, "parsed", type = "application/json")
# 
#   # Print the parsed content
#   #print(content)
# 
#   # for (i in 1:length(content$items)){
#   #   print(i)
#   # }
# 
#   Title = content[[1]][["title"]]
#   Citation = content[[1]][["citation"]]
#   ReferenceURL = content[[1]][["referenceUrl"]]
#   TypeName = content[[1]][["typeName"]]
#   cat(Title,"  \n")
#   cat(Citation,"  \n")
#   cat(ReferenceURL,"  \n")
#   cat(url,"  \n")
#   cat(TypeName,"  \n")
# 
#   
# } else {
#   # Handle errors
#   print(paste("Request failed with status code", status_code))
# }
```
